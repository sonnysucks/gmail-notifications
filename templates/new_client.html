{% extends "base.html" %}

{% block title %}Add New Client - {{ business.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Add New Client</h1>
            <p class="text-muted mb-0">Create a new client profile for your photography business</p>
        </div>
        <a href="{{ url_for('clients') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Clients
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Client Information Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        Client Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="newClientForm">
                        <!-- Basic Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                            <div class="col-md-6">
                                <label for="family_type" class="form-label">Family Type</label>
                                <select class="form-select" id="family_type" name="family_type">
                                    <option value="">Select family type</option>
                                    <option value="newborn">Newborn</option>
                                    <option value="milestone">Milestone</option>
                                    <option value="birthday">Birthday</option>
                                    <option value="family">Family</option>
                                    <option value="maternity">Maternity</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>



                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="due_date" class="form-label">Due Date (if pregnant)</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                            <div class="col-md-6">
                                <label for="children_count" class="form-label">Number of Children</label>
                                <select class="form-select" id="children_count" name="children_count" onchange="updateChildFields()">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Child Names Section -->
                        <div class="row g-3 mb-4" id="child_names_section">
                            <div class="col-12">
                                <label class="form-label">Child Names & Birth Dates</label>
                                <div id="child_names_container">
                                    <!-- Child name fields will be dynamically generated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="referral_source" class="form-label">Referral Source</label>
                                <select class="form-select" id="referral_source" name="referral_source" onchange="handleOtherOption(this, 'referral_source')">
                                    <option value="">Select referral source</option>
                                    <option value="social_media">Social Media</option>
                                    <option value="google">Google Search</option>
                                    <option value="friend">Friend/Family</option>
                                    <option value="previous_client">Previous Client</option>
                                    <option value="other">Other</option>
                                </select>
                                <div id="referral_source_other" class="mt-2" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="referral_source_custom" name="referral_source_custom" 
                                               placeholder="Please specify referral source"
                                               onkeypress="handleCustomInputKeypress(event, 'referral_source')">
                                        <button type="button" class="btn btn-outline-primary" onclick="submitCustomOption('referral_source')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="photography_experience" class="form-label">Photography Experience</label>
                                <select class="form-select" id="photography_experience" name="photography_experience" onchange="handleOtherOption(this, 'photography_experience')">
                                    <option value="">Select experience level</option>
                                    <option value="first_time">First Time</option>
                                    <option value="some_experience">Some Experience</option>
                                    <option value="experienced">Experienced</option>
                                    <option value="professional">Professional</option>
                                    <option value="other">Other</option>
                                </select>
                                <div id="photography_experience_other" class="mt-2" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="photography_experience_custom" name="photography_experience_custom" 
                                               placeholder="Please specify experience level"
                                               onkeypress="handleCustomInputKeypress(event, 'photography_experience')">
                                        <button type="button" class="btn btn-outline-primary" onclick="submitCustomOption('photography_experience')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="budget" class="form-label">Budget Range</label>
                                <select class="form-select" id="budget" name="budget" onchange="handleOtherOption(this, 'budget')">
                                    <option value="">Select budget range</option>
                                    <option value="under_200">Under $200</option>
                                    <option value="200_400">$200 - $400</option>
                                    <option value="400_600">$400 - $600</option>
                                    <option value="600_800">$600 - $800</option>
                                    <option value="over_800">Over $800</option>
                                    <option value="other">Other</option>
                                </select>
                                <div id="budget_other" class="mt-2" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="budget_custom" name="budget_custom" 
                                               placeholder="Please specify budget range"
                                               onkeypress="handleCustomInputKeypress(event, 'budget')">
                                        <button type="button" class="btn btn-outline-primary" onclick="submitCustomOption('budget')">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                    </div>
                            </div>
                            <div class="col-md-6">
                                <label for="preferred_style" class="form-label">Preferred Style</label>
                                <select class="form-select" id="preferred_style" name="preferred_style" onchange="handleOtherOption(this, 'preferred_style')">
                                    <option value="">Select preferred style</option>
                                    <option value="natural">Natural/Lifestyle</option>
                                    <option value="posed">Posed/Classic</option>
                                    <option value="artistic">Artistic/Creative</option>
                                    <option value="vintage">Vintage/Retro</option>
                                    <option value="modern">Modern/Minimalist</option>
                                    <option value="other">Other</option>
                                </select>
                                <div id="preferred_style_other" class="mt-2" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="preferred_style_custom" name="preferred_style_custom" 
                                               placeholder="Please specify preferred style"
                                               onkeypress="handleCustomInputKeypress(event, 'preferred_style')">
                                        <button type="button" class="btn btn-outline-primary" onclick="submitCustomOption('preferred_style')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2" placeholder="Street address, city, state, zip"></textarea>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="tags" class="form-label">Tags</label>
                                <input type="text" class="form-control" id="tags" name="tags" placeholder="Enter tags separated by commas (e.g., newborn, milestone, family)">
                                <small class="text-muted">Use tags to categorize and organize your clients</small>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional notes about this client..."></textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Create Client
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>
                                Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Tips -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Quick Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Required fields:</strong> Name and email
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Baby information:</strong> Essential for session planning
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Tags:</strong> Help organize and find clients quickly
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Notes:</strong> Capture important details and preferences
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Custom Options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Your Custom Options
                    </h6>
                </div>
                <div class="card-body">
                    <div id="customOptionsDisplay">
                        <!-- Custom options will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Baby Age Calculator -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Baby Age Calculator
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="calc_birth_date" class="form-label">Birth Date</label>
                        <input type="date" class="form-control" id="calc_birth_date">
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="calculateAge()">
                        Calculate Age
                    </button>
                    <div id="ageResult" class="mt-3 p-3 bg-light rounded" style="display: none;">
                        <div id="ageText"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Child fields styling */
    .child-field {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .child-field:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .child-field-number {
        background: #007bff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 0.5rem;
    }
    
    /* Custom options styling */
    .custom-option-badge {
        position: relative;
        transition: all 0.2s ease;
    }
    
    .custom-option-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .custom-option-badge .btn-close {
        font-size: 0.6rem;
        padding: 0.125rem;
        margin-left: 0.25rem;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    
    .custom-option-badge:hover .btn-close {
        opacity: 1;
    }
    
    .input-group .btn {
        border-left: 0;
    }
    
    .input-group .form-control:focus {
        border-right: 0;
        box-shadow: none;
    }
    
    /* Age calculator styling */
    #ageResult {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    #ageResult .h5 {
        color: #495057;
        font-weight: 600;
    }
    
    #ageResult .badge {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
        margin: 0.25rem;
    }
    
    #ageResult .text-muted {
        color: #6c757d !important;
        font-size: 0.875rem;
    }
    
    #ageResult .badge[title] {
        cursor: help;
    }
    
    #ageResult .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }
    
    #ageResult .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newClientForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        createClient();
    });
});

function createClient() {
    const formData = new FormData(document.getElementById('newClientForm'));
    const clientData = {};
    
    // Convert FormData to object
    for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
            clientData[key] = value.trim();
        }
    }
    
    // Collect child information
    const childrenCount = parseInt(document.getElementById('children_count').value);
    const children = [];
    
    for (let i = 1; i <= childrenCount; i++) {
        const childName = document.getElementById(`child_name_${i}`)?.value?.trim();
        const childBirthDate = document.getElementById(`child_birth_date_${i}`)?.value;
        
        if (childName || childBirthDate) {
            children.push({
                name: childName || '',
                birth_date: childBirthDate || '',
                order: i
            });
        }
    }
    
    // Add children array to client data
    if (children.length > 0) {
        clientData.children = children;
    }
    
    // Handle custom "Other" values and save them
    const fieldsWithOther = ['referral_source', 'photography_experience', 'budget', 'preferred_style'];
    
    fieldsWithOther.forEach(fieldName => {
        const selectValue = document.getElementById(fieldName).value;
        const customInput = document.getElementById(`${fieldName}_custom`);
        
        if (selectValue === 'other' && customInput && customInput.value.trim()) {
            const customValue = customInput.value.trim();
            clientData[fieldName] = customValue;
            
            // Save the custom option for future use
            saveCustomOption(fieldName, customValue);
        }
    });
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
    submitBtn.disabled = true;
    
    // Send request
    fetch('/clients/new', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(clientData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('Client created successfully!', 'success');
            
            // Redirect to client list after a short delay
            setTimeout(() => {
                window.location.href = '/clients';
            }, 1500);
        } else {
            showAlert('Error creating client: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error creating client. Please try again.', 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function resetForm() {
    document.getElementById('newClientForm').reset();
    document.getElementById('ageResult').style.display = 'none';
    updateChildFields(); // Reset child fields to default
}

function updateChildFields() {
    const childrenCount = parseInt(document.getElementById('children_count').value);
    const container = document.getElementById('child_names_container');
    
    // Clear existing fields
    container.innerHTML = '';
    
    // Generate fields for each child
    for (let i = 1; i <= childrenCount; i++) {
        const childField = document.createElement('div');
        childField.className = 'child-field';
        childField.innerHTML = `
            <div class="d-flex align-items-center mb-3">
                <span class="child-field-number">${i}</span>
                <h6 class="mb-0">Child ${i} Information</h6>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="child_name_${i}" class="form-label">Child ${i} Name</label>
                    <input type="text" class="form-control" id="child_name_${i}" name="child_name_${i}" 
                           placeholder="Enter child ${i}'s name">
                </div>
                <div class="col-md-6">
                    <label for="child_birth_date_${i}" class="form-label">Child ${i} Birth Date</label>
                    <input type="date" class="form-control" id="child_birth_date_${i}" name="child_birth_date_${i}">
                </div>
            </div>
        `;
        container.appendChild(childField);
    }
    
    // Hide section if no children
    const section = document.getElementById('child_names_section');
    if (childrenCount === 0) {
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
    }
}

// Initialize child fields when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateChildFields();
    loadDynamicOptions(); // Load any previously saved custom options
});

// Handle "Other" option selection
function handleOtherOption(selectElement, fieldName) {
    const otherDiv = document.getElementById(`${fieldName}_other`);
    const customInput = document.getElementById(`${fieldName}_custom`);
    
    if (selectElement.value === 'other') {
        otherDiv.style.display = 'block';
        customInput.focus();
        customInput.required = true;
    } else {
        otherDiv.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
}

// Load dynamic options from localStorage
function loadDynamicOptions() {
    const fields = ['referral_source', 'photography_experience', 'budget', 'preferred_style'];
    
    fields.forEach(fieldName => {
        const savedOptions = JSON.parse(localStorage.getItem(`${fieldName}_options`) || '[]');
        if (savedOptions.length > 0) {
            updateDropdownOptions(fieldName, savedOptions);
        }
    });
    
    // Display custom options in the sidebar
    displayCustomOptions();
}

// Display custom options in the sidebar
function displayCustomOptions() {
    const displayDiv = document.getElementById('customOptionsDisplay');
    const fields = [
        { name: 'referral_source', label: 'Referral Sources' },
        { name: 'photography_experience', label: 'Experience Levels' },
        { name: 'budget', label: 'Budget Ranges' },
        { name: 'preferred_style', label: 'Preferred Styles' }
    ];
    
    let html = '';
    
    fields.forEach(field => {
        const savedOptions = JSON.parse(localStorage.getItem(`${field.name}_options`) || '[]');
        if (savedOptions.length > 0) {
            html += `
                <div class="mb-3">
                    <h6 class="text-primary mb-2">${field.label}</h6>
                    <div class="d-flex flex-wrap gap-1">
                        ${savedOptions.map(option => `
                            <span class="badge bg-light text-dark border custom-option-badge">
                                ${option}
                                <button type="button" class="btn-close btn-close-sm" 
                                        onclick="removeCustomOption('${field.name}', '${option}')" 
                                        title="Remove this option"></button>
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = '<p class="text-muted small mb-0">No custom options yet. Select "Other" in any dropdown to add custom values.</p>';
    } else {
        html += `
            <hr class="my-3">
            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="clearAllCustomOptions()">
                <i class="fas fa-trash me-2"></i>Clear All Custom Options
            </button>
        `;
    }
    
    displayDiv.innerHTML = html;
}

// Update dropdown options with custom values
function updateDropdownOptions(fieldName, customOptions) {
    const select = document.getElementById(fieldName);
    const originalOptions = getOriginalOptions(fieldName);
    
    // Clear existing options
    select.innerHTML = '';
    
    // Add default "Select" option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = `Select ${fieldName.replace('_', ' ')}`;
    select.appendChild(defaultOption);
    
    // Add original options
    originalOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        select.appendChild(optionElement);
    });
    
    // Add custom options
    customOptions.forEach(customOption => {
        const optionElement = document.createElement('option');
        optionElement.value = customOption;
        optionElement.textContent = customOption;
        select.appendChild(optionElement);
    });
    
    // Add "Other" option at the end
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'Other';
    select.appendChild(otherOption);
}

// Get original options for each field
function getOriginalOptions(fieldName) {
    const optionsMap = {
        referral_source: [
            { value: 'social_media', text: 'Social Media' },
            { value: 'google', text: 'Google Search' },
            { value: 'friend', text: 'Friend/Family' },
            { value: 'previous_client', text: 'Previous Client' }
        ],
        photography_experience: [
            { value: 'first_time', text: 'First Time' },
            { value: 'some_experience', text: 'Some Experience' },
            { value: 'experienced', text: 'Experienced' },
            { value: 'professional', text: 'Professional' }
        ],
        budget: [
            { value: 'under_200', text: 'Under $200' },
            { value: '200_400', text: '$200 - $400' },
            { value: '400_600', text: '$400 - $600' },
            { value: '600_800', text: '$600 - $800' },
            { value: 'over_800', text: 'Over $800' }
        ],
        preferred_style: [
            { value: 'natural', text: 'Natural/Lifestyle' },
            { value: 'posed', text: 'Posed/Classic' },
            { value: 'artistic', text: 'Artistic/Creative' },
            { value: 'vintage', text: 'Vintage/Retro' },
            { value: 'modern', text: 'Modern/Minimalist' }
        ]
    };
    
    return optionsMap[fieldName] || [];
}

// Save custom option to localStorage and update dropdown
function saveCustomOption(fieldName, customValue) {
    if (!customValue || customValue.trim() === '') return;
    
    const savedOptions = JSON.parse(localStorage.getItem(`${fieldName}_options`) || '[]');
    
    // Add new option if it doesn't exist
    if (!savedOptions.includes(customValue.trim())) {
        savedOptions.push(customValue.trim());
        localStorage.setItem(`${fieldName}_options`, JSON.stringify(savedOptions));
        
        // Update the dropdown to include the new option
        updateDropdownOptions(fieldName, savedOptions);
        
        // Set the value to the new custom option
        const select = document.getElementById(fieldName);
        select.value = customValue.trim();
        
        // Hide the "Other" input field
        const otherDiv = document.getElementById(`${fieldName}_other`);
        otherDiv.style.display = 'none';
        
        // Clear the custom input
        const customInput = document.getElementById(`${fieldName}_custom`);
        customInput.value = '';
        customInput.required = false;
        
        // Refresh the custom options display
        displayCustomOptions();
    }
}

// Submit custom option when user clicks the plus button
function submitCustomOption(fieldName) {
    const customInput = document.getElementById(`${fieldName}_custom`);
    const customValue = customInput.value.trim();
    
    if (customValue) {
        saveCustomOption(fieldName, customValue);
        showAlert(`"${customValue}" added to ${fieldName.replace('_', ' ')} options!`, 'success');
    } else {
        showAlert('Please enter a value before adding.', 'error');
    }
}

// Handle Enter key press in custom input fields
function handleCustomInputKeypress(event, fieldName) {
    if (event.key === 'Enter') {
        event.preventDefault();
        submitCustomOption(fieldName);
    }
}

// Remove custom option
function removeCustomOption(fieldName, optionValue) {
    if (confirm(`Are you sure you want to remove "${optionValue}" from ${fieldName.replace('_', ' ')}?`)) {
        const savedOptions = JSON.parse(localStorage.getItem(`${fieldName}_options`) || '[]');
        const updatedOptions = savedOptions.filter(option => option !== optionValue);
        localStorage.setItem(`${fieldName}_options`, JSON.stringify(updatedOptions));
        
        // Update the dropdown options
        updateDropdownOptions(fieldName, updatedOptions);
        
        // Refresh the custom options display
        displayCustomOptions();
        
        showAlert(`"${optionValue}" removed from ${fieldName.replace('_', ' ')} options.`, 'success');
    }
}

// Clear all custom options
function clearAllCustomOptions() {
    if (confirm('Are you sure you want to clear all custom options? This action cannot be undone.')) {
        const fields = ['referral_source', 'photography_experience', 'budget', 'preferred_style'];
        
        fields.forEach(fieldName => {
            localStorage.removeItem(`${fieldName}_options`);
            updateDropdownOptions(fieldName, []);
        });
        
        // Refresh the custom options display
        displayCustomOptions();
        
        showAlert('All custom options have been cleared.', 'success');
    }
}

function calculateAge() {
    const birthDate = document.getElementById('calc_birth_date').value;
    if (!birthDate) {
        alert('Please enter a birth date');
        return;
    }
    
    const today = new Date();
    const birth = new Date(birthDate);
    
    // Calculate age in years, months, and days
    let years = today.getFullYear() - birth.getFullYear();
    let months = today.getMonth() - birth.getMonth();
    let days = today.getDate() - birth.getDate();
    
    // Adjust for negative months or days
    if (days < 0) {
        months--;
        // Get the last day of the previous month
        const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        days += lastMonth.getDate();
    }
    
    if (months < 0) {
        years--;
        months += 12;
    }
    
    // Calculate total days for additional context
    const ageInMs = today - birth;
    const totalDays = Math.floor(ageInMs / (1000 * 60 * 60 * 24));
    
    // Build age text with detailed breakdown
    let ageText = '';
    let ageDetails = '';
    
    if (years > 0) {
        ageText = `${years} year${years !== 1 ? 's' : ''}`;
        if (months > 0) {
            ageText += `, ${months} month${months !== 1 ? 's' : ''}`;
        }
        if (days > 0) {
            ageText += `, ${days} day${days !== 1 ? 's' : ''}`;
        }
    } else if (months > 0) {
        ageText = `${months} month${months !== 1 ? 's' : ''}`;
        if (days > 0) {
            ageText += `, ${days} day${days !== 1 ? 's' : ''}`;
        }
    } else {
        ageText = `${days} day${days !== 1 ? 's' : ''}`;
    }
    
    // Add weeks for babies under 3 months
    if (totalDays <= 90) {
        const weeks = Math.floor(totalDays / 7);
        const remainingDays = totalDays % 7;
        if (weeks > 0) {
            ageText = `${weeks} week${weeks !== 1 ? 's' : ''}`;
            if (remainingDays > 0) {
                ageText += `, ${remainingDays} day${remainingDays !== 1 ? 's' : ''}`;
            }
        }
    }
    
    ageText += ' old';
    
    // Add photography session recommendations based on age
    let sessionType = '';
    let milestoneInfo = '';
    
    if (totalDays <= 14) {
        sessionType = 'Newborn Session (0-14 days)';
        milestoneInfo = 'Perfect timing for newborn photos!';
    } else if (totalDays <= 90) {
        sessionType = 'Newborn Session (2 weeks - 3 months)';
        milestoneInfo = 'Still great for newborn-style photos';
    } else if (totalDays <= 180) {
        sessionType = 'Milestone Session (3-6 months)';
        milestoneInfo = 'Great age for milestone photos - sitting up, smiling';
    } else if (totalDays <= 365) {
        sessionType = 'Milestone Session (6-12 months)';
        milestoneInfo = 'Perfect for milestone photos - crawling, standing';
    } else if (totalDays <= 730) {
        sessionType = 'Birthday Session (1-2 years)';
        milestoneInfo = 'Great for birthday and milestone photos';
    } else {
        sessionType = 'Family Session (2+ years)';
        milestoneInfo = 'Perfect for family and milestone photos';
    }
    
    // Calculate upcoming milestone dates
    let upcomingMilestones = [];
    const milestones = [30, 60, 90, 180, 365, 730, 1095]; // days
    
    milestones.forEach(milestone => {
        if (totalDays < milestone) {
            const daysUntil = milestone - totalDays;
            const milestoneDate = new Date(birth.getTime() + (milestone * 24 * 60 * 60 * 1000));
            upcomingMilestones.push({
                days: milestone,
                daysUntil: daysUntil,
                date: milestoneDate.toLocaleDateString(),
                label: milestone === 30 ? '1 Month' : 
                       milestone === 60 ? '2 Months' : 
                       milestone === 90 ? '3 Months' : 
                       milestone === 180 ? '6 Months' : 
                       milestone === 365 ? '1 Year' : 
                       milestone === 730 ? '2 Years' : '3 Years'
            });
        }
    });
    
    // Display detailed results
    let milestoneHTML = '';
    if (upcomingMilestones.length > 0) {
        milestoneHTML = `
            <div class="mt-3">
                <div class="small text-muted mb-2">Upcoming Milestones:</div>
                <div class="d-flex flex-wrap gap-1 justify-content-center">
                    ${upcomingMilestones.slice(0, 3).map(milestone => `
                        <span class="badge bg-warning text-dark" title="${milestone.label} on ${milestone.date}">
                            ${milestone.label} in ${milestone.daysUntil} days
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Create photography-friendly age display
    let photographyAge = '';
    if (totalDays <= 14) {
        photographyAge = `${totalDays} days old`;
    } else if (totalDays <= 90) {
        const weeks = Math.floor(totalDays / 7);
        photographyAge = `${weeks} weeks old`;
    } else if (totalDays <= 365) {
        const months = Math.floor(totalDays / 30.44); // More accurate month calculation
        photographyAge = `${months} months old`;
    } else {
        const years = Math.floor(totalDays / 365.25); // Account for leap years
        photographyAge = `${years} years old`;
    }
    
    document.getElementById('ageText').innerHTML = `
        <div class="text-center">
            <div class="h5 text-primary mb-2">${ageText}</div>
            <div class="small text-muted mb-2">Total: ${totalDays} days</div>
            <div class="badge bg-secondary mb-2">${photographyAge}</div>
            <div class="badge bg-info mb-2">${sessionType}</div>
            <div class="small text-success mb-2">${milestoneInfo}</div>
            ${milestoneHTML}
        </div>
    `;
    document.getElementById('ageResult').style.display = 'block';
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of form
    const form = document.getElementById('newClientForm');
    form.parentNode.insertBefore(alertDiv, form);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
