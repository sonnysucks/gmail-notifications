{% extends "base.html" %}

{% block title %}Edit Client - {{ business.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Edit Client</h1>
            <p class="text-muted mb-0">Update client information and preferences</p>
        </div>
        <a href="{{ url_for('clients') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Clients
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Client Information Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        Edit Client Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="editClientForm">
                        <!-- Basic Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ client.name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ client.email }}" required>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" value="{{ client.phone or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="family_type" class="form-label">Family Type</label>
                                <select class="form-select" id="family_type" name="family_type">
                                    <option value="">Select family type</option>
                                    <option value="newborn" {% if client.family_type == 'newborn' %}selected{% endif %}>Newborn</option>
                                    <option value="milestone" {% if client.family_type == 'milestone' %}selected{% endif %}>Milestone</option>
                                    <option value="birthday" {% if client.birthday == 'birthday' %}selected{% endif %}>Birthday</option>
                                    <option value="family" {% if client.family_type == 'family' %}selected{% endif %}>Family</option>
                                    <option value="maternity" {% if client.family_type == 'maternity' %}selected{% endif %}>Maternity</option>
                                    <option value="other" {% if client.family_type == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Baby/Child Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="baby_name" class="form-label">Baby/Child Name</label>
                                <input type="text" class="form-control" id="baby_name" name="baby_name" value="{{ client.baby_name or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="baby_birth_date" class="form-label">Baby/Child Birth Date</label>
                                <input type="date" class="form-control" id="baby_birth_date" name="baby_birth_date" value="{{ client.baby_birth_date or '' }}">
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="due_date" class="form-label">Due Date (if pregnant)</label>
                                <input type="date" class="form-control" id="due_date" name="due_date" value="{{ client.due_date or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="children_count" class="form-label">Number of Children</label>
                                <select class="form-select" id="children_count" name="children_count" onchange="updateChildFields()">
                                    <option value="1" {% if client.children_count == '1' %}selected{% endif %}>1</option>
                                    <option value="2" {% if client.children_count == '2' %}selected{% endif %}>2</option>
                                    <option value="3" {% if client.children_count == '3' %}selected{% endif %}>3</option>
                                    <option value="4" {% if client.children_count == '4' %}selected{% endif %}>4</option>
                                    <option value="5" {% if client.children_count == '5' %}selected{% endif %}>5</option>
                                    <option value="6" {% if client.children_count == '6' %}selected{% endif %}>6</option>
                                    <option value="7" {% if client.children_count == '7' %}selected{% endif %}>7</option>
                                    <option value="8" {% if client.children_count == '8' %}selected{% endif %}>8</option>
                                    <option value="9" {% if client.children_count == '9' %}selected{% endif %}>9</option>
                                    <option value="10" {% if client.children_count == '10' %}selected{% endif %}>10</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Child Names Section -->
                        <div class="row g-3 mb-4" id="child_names_section">
                            <div class="col-12">
                                <label class="form-label">Child Names & Birth Dates</label>
                                <div id="child_names_container">
                                    <!-- Child name fields will be dynamically generated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="referral_source" class="form-label">Referral Source</label>
                                <select class="form-select" id="referral_source" name="referral_source">
                                    <option value="">Select referral source</option>
                                    <option value="social_media" {% if client.referral_source == 'social_media' %}selected{% endif %}>Social Media</option>
                                    <option value="google" {% if client.referral_source == 'google' %}selected{% endif %}>Google Search</option>
                                    <option value="friend" {% if client.referral_source == 'friend' %}selected{% endif %}>Friend/Family</option>
                                    <option value="previous_client" {% if client.referral_source == 'previous_client' %}selected{% endif %}>Previous Client</option>
                                    <option value="other" {% if client.referral_source == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="photography_experience" class="form-label">Photography Experience</label>
                                <select class="form-select" id="photography_experience" name="photography_experience">
                                    <option value="">Select experience level</option>
                                    <option value="first_time" {% if client.photography_experience == 'first_time' %}selected{% endif %}>First Time</option>
                                    <option value="some_experience" {% if client.photography_experience == 'some_experience' %}selected{% endif %}>Some Experience</option>
                                    <option value="experienced" {% if client.photography_experience == 'experienced' %}selected{% endif %}>Experienced</option>
                                    <option value="professional" {% if client.photography_experience == 'professional' %}selected{% endif %}>Professional</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="budget" class="form-label">Budget Range</label>
                                <select class="form-select" id="budget" name="budget">
                                    <option value="">Select budget range</option>
                                    <option value="under_200" {% if client.budget == 'under_200' %}selected{% endif %}>Under $200</option>
                                    <option value="200_400" {% if client.budget == '200_400' %}selected{% endif %}>$200 - $400</option>
                                    <option value="400_600" {% if client.budget == '400_600' %}selected{% endif %}>$400 - $600</option>
                                    <option value="600_800" {% if client.budget == '600_800' %}selected{% endif %}>$600 - $800</option>
                                    <option value="over_800" {% if client.budget == 'over_800' %}selected{% endif %}>Over $800</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="preferred_style" class="form-label">Preferred Style</label>
                                <select class="form-select" id="preferred_style" name="preferred_style">
                                    <option value="">Select preferred style</option>
                                    <option value="natural" {% if client.preferred_style == 'natural' %}selected{% endif %}>Natural/Lifestyle</option>
                                    <option value="posed" {% if client.preferred_style == 'posed' %}selected{% endif %}>Posed/Classic</option>
                                    <option value="artistic" {% if client.preferred_style == 'artistic' %}selected{% endif %}>Artistic/Creative</option>
                                    <option value="vintage" {% if client.preferred_style == 'vintage' %}selected{% endif %}>Vintage/Retro</option>
                                    <option value="modern" {% if client.preferred_style == 'modern' %}selected{% endif %}>Modern/Minimalist</option>
                                </select>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2" placeholder="Street address, city, state, zip">{{ client.address or '' }}</textarea>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="tags" class="form-label">Tags</label>
                                <input type="text" class="form-control" id="tags" name="tags" value="{{ client.tags or '' }}" placeholder="Enter tags separated by commas (e.g., newborn, milestone, family)">
                                <small class="text-muted">Use tags to categorize and organize your clients</small>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional notes about this client...">{{ client.notes or '' }}</textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Update Client
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>
                                Reset Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Client Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-user me-2"></i>
                        Client Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">{{ client.name }}</h6>
                            <small class="text-muted">{{ client.email }}</small>
                        </div>
                    </div>
                    
                    {% if client.family_type %}
                    <div class="mb-2">
                        <strong>Family Type:</strong> {{ client.family_type.title() }}
                    </div>
                    {% endif %}
                    
                    {% if client.baby_name %}
                    <div class="mb-2">
                        <strong>Baby/Child:</strong> {{ client.baby_name }}
                    </div>
                    {% endif %}
                    
                    {% if client.phone %}
                    <div class="mb-2">
                        <strong>Phone:</strong> {{ client.phone }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('new_appointment') }}?client_id={{ client.id }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-calendar-plus me-2"></i>
                            Schedule Session
                        </a>
                        <a href="{{ url_for('view_client', client_id=client.id) }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-eye me-2"></i>
                            View Client Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Child fields styling */
    .child-field {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .child-field:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .child-field-number {
        background: #007bff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editClientForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        updateClient();
    });
});

function updateClient() {
    const formData = new FormData(document.getElementById('editClientForm'));
    const clientData = {};
    
    // Convert FormData to object
    for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
            clientData[key] = value.trim();
        }
    }
    
    // Collect child information
    const childrenCount = parseInt(document.getElementById('children_count').value);
    const children = [];
    
    for (let i = 1; i <= childrenCount; i++) {
        const childName = document.getElementById(`child_name_${i}`)?.value?.trim();
        const childBirthDate = document.getElementById(`child_birth_date_${i}`)?.value;
        
        if (childName || childBirthDate) {
            children.push({
                name: childName || '',
                birth_date: childBirthDate || '',
                order: i
            });
        }
    }
    
    // Add children array to client data
    if (children.length > 0) {
        clientData.children = children;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;
    
    // Send request
    fetch('/clients/{{ client.id }}/edit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(clientData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('Client updated successfully!', 'success');
            
            // Redirect to client list after a short delay
            setTimeout(() => {
                window.location.href = '/clients';
            }, 1500);
        } else {
            showAlert('Error updating client: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating client. Please try again.', 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function resetForm() {
    // Reset form to original values
    document.getElementById('editClientForm').reset();
    updateChildFields(); // Reset child fields to default
}

function updateChildFields() {
    const childrenCount = parseInt(document.getElementById('children_count').value);
    const container = document.getElementById('child_names_container');
    
    // Clear existing fields
    container.innerHTML = '';
    
    // Generate fields for each child
    for (let i = 1; i <= childrenCount; i++) {
        const childField = document.createElement('div');
        childField.className = 'child-field';
        childField.innerHTML = `
            <div class="d-flex align-items-center mb-3">
                <span class="child-field-number">${i}</span>
                <h6 class="mb-0">Child ${i} Information</h6>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="child_name_${i}" class="form-label">Child ${i} Name</label>
                    <input type="text" class="form-control" id="child_name_${i}" name="child_name_${i}" 
                           placeholder="Enter child ${i}'s name">
                </div>
                <div class="col-md-6">
                    <label for="child_birth_date_${i}" class="form-label">Child ${i} Birth Date</label>
                    <input type="date" class="form-control" id="child_birth_date_${i}" name="child_birth_date_${i}">
                </div>
            </div>
        `;
        container.appendChild(childField);
    }
    
    // Hide section if no children
    const section = document.getElementById('child_names_section');
    if (childrenCount === 0) {
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
    }
}

// Initialize child fields when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateChildFields();
});

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of form
    const form = document.getElementById('editClientForm');
    form.parentNode.insertBefore(alertDiv, form);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
