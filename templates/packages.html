{% extends "base.html" %}

{% block title %}Package Management - {{ business.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Package Management</h1>
            <p class="text-muted mb-0">Create and manage photography packages with customizable pricing</p>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#packageModal" onclick="openPackageModal()">
            <i class="fas fa-plus me-2"></i>
            New Package
        </button>
    </div>

    <!-- Package Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary active" data-category="all" onclick="filterPackages('all')">
                            All Packages
                        </button>
                        <button class="btn btn-outline-primary" data-category="maternity" onclick="filterPackages('maternity')">
                            Maternity
                        </button>
                        <button class="btn btn-outline-primary" data-category="newborn" onclick="filterPackages('newborn')">
                            Newborn
                        </button>
                        <button class="btn btn-outline-primary" data-category="milestone" onclick="filterPackages('milestone')">
                            Milestone
                        </button>
                        <button class="btn btn-outline-primary" data-category="birthday" onclick="filterPackages('birthday')">
                            Birthday
                        </button>
                        <button class="btn btn-outline-primary" data-category="family" onclick="filterPackages('family')">
                            Family
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Packages Grid -->
    <div class="row g-4" id="packagesGrid">
        <!-- Packages will be loaded dynamically -->
    </div>

    <!-- Empty State -->
    <div class="text-center py-5 d-none" id="emptyState">
        <i class="fas fa-box text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">No packages found</h5>
        <p class="text-muted">Create your first photography package</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#packageModal" onclick="openPackageModal()">
            <i class="fas fa-plus me-2"></i>
            Create Package
        </button>
    </div>
</div>

<!-- Package Modal -->
<div class="modal fade" id="packageModal" tabindex="-1" aria-labelledby="packageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packageModalLabel">Create New Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="packageForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Basic Information -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Basic Information
                            </h6>
                        </div>
                        
                        <div class="col-md-8">
                            <label for="packageName" class="form-label">Package Name *</label>
                            <input type="text" class="form-control" id="packageName" name="name" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="packageCategory" class="form-label">Category *</label>
                            <select class="form-select" id="packageCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="maternity">Maternity</option>
                                <option value="newborn">Newborn</option>
                                <option value="milestone">Milestone</option>
                                <option value="birthday">Birthday</option>
                                <option value="family">Family</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label for="packageDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="packageDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <!-- Pricing Information -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3 mt-3">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Pricing Information
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="basePrice" class="form-label">Base Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="basePrice" name="base_price" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="durationMinutes" class="form-label">Duration (minutes) *</label>
                            <input type="number" class="form-control" id="durationMinutes" name="duration_minutes" required>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isCustomizable" name="is_customizable" checked>
                                <label class="form-check-label" for="isCustomizable">
                                    Allow customization of this package
                                </label>
                            </div>
                        </div>
                        
                        <!-- Package Details -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3 mt-3">
                                <i class="fas fa-list me-2"></i>
                                Package Details
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="includes" class="form-label">What's Included</label>
                            <textarea class="form-control" id="includes" name="includes" rows="4" placeholder="Enter each item on a new line"></textarea>
                            <small class="text-muted">Enter each included item on a new line</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="requirements" class="form-label">Requirements/Notes</label>
                            <textarea class="form-control" id="requirements" name="requirements" rows="4" placeholder="Enter each requirement on a new line"></textarea>
                            <small class="text-muted">Enter each requirement on a new line</small>
                        </div>
                        
                        <!-- Session Information -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3 mt-3">
                                <i class="fas fa-camera me-2"></i>
                                Session Information
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="recommendedAge" class="form-label">Recommended Age</label>
                            <input type="text" class="form-control" id="recommendedAge" name="recommended_age" placeholder="e.g., 5-14 days">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="recommendedWeeks" class="form-label">Recommended Weeks (Maternity)</label>
                            <input type="text" class="form-control" id="recommendedWeeks" name="recommended_weeks" placeholder="e.g., 28-36 weeks">
                        </div>
                        
                        <div class="col-12">
                            <label for="optimalTiming" class="form-label">Optimal Timing/Notes</label>
                            <input type="text" class="form-control" id="optimalTiming" name="optimal_timing" placeholder="e.g., Best in morning light">
                        </div>
                        
                        <!-- Display Options -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3 mt-3">
                                <i class="fas fa-cog me-2"></i>
                                Display Options
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="displayOrder" class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="displayOrder" name="display_order" value="0">
                            <small class="text-muted">Lower numbers appear first</small>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isFeatured" name="is_featured">
                                <label class="form-check-label" for="isFeatured">
                                    Featured Package
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                <label class="form-check-label" for="isActive">
                                    Active Package
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="savePackageBtn">
                        <i class="fas fa-save me-2"></i>
                        Save Package
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this package? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Package</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPackageId = null;
let currentDeleteId = null;

// Load packages on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPackages();
});

function loadPackages() {
    fetch('/api/packages')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPackages(data.packages);
            } else {
                showAlert('Failed to load packages: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            showAlert('Error loading packages', 'danger');
        });
}

function displayPackages(packages) {
    const grid = document.getElementById('packagesGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (packages.length === 0) {
        grid.innerHTML = '';
        emptyState.classList.remove('d-none');
        return;
    }
    
    emptyState.classList.add('d-none');
    
    grid.innerHTML = packages.map(package => `
        <div class="col-lg-4 col-md-6 package-card" data-category="${package.category}">
            <div class="card h-100 ${package.is_featured ? 'border-warning' : ''}">
                ${package.is_featured ? '<div class="badge bg-warning position-absolute top-0 end-0 m-2">Featured</div>' : ''}
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${package.name}</h6>
                        <small class="text-muted">${package.category.charAt(0).toUpperCase() + package.category.slice(1)}</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="editPackage('${package.id}')">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="duplicatePackage('${package.id}')">
                                <i class="fas fa-copy me-2"></i>Duplicate
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePackage('${package.id}')">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-success mb-0">$${package.base_price}</span>
                            <small class="text-muted">${package.duration_minutes} min</small>
                        </div>
                        ${package.description ? `<p class="text-muted small mb-2">${package.description}</p>` : ''}
                    </div>
                    
                    ${package.includes && package.includes.length > 0 ? `
                        <div class="mb-3">
                            <h6 class="small text-muted mb-2">Includes:</h6>
                            <ul class="small mb-0">
                                ${package.includes.slice(0, 3).map(item => `<li>${item}</li>`).join('')}
                                ${package.includes.length > 3 ? `<li class="text-muted">+${package.includes.length - 3} more items</li>` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${package.recommended_age || package.recommended_weeks ? `
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ${package.recommended_age || package.recommended_weeks}
                            </small>
                        </div>
                    ` : ''}
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${package.is_customizable ? '<span class="badge bg-info">Customizable</span>' : ''}
                            ${!package.is_active ? '<span class="badge bg-secondary">Inactive</span>' : ''}
                        </div>
                        <small class="text-muted">#${package.display_order}</small>
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="editPackage('${package.id}')">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="customizePackage('${package.id}')">
                            <i class="fas fa-cog me-1"></i>Customize
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function filterPackages(category) {
    // Update active button
    document.querySelectorAll('[data-category]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    
    // Filter package cards
    const cards = document.querySelectorAll('.package-card');
    cards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

function openPackageModal(packageId = null) {
    currentPackageId = packageId;
    const modal = document.getElementById('packageModal');
    const form = document.getElementById('packageForm');
    const title = document.getElementById('packageModalLabel');
    
    if (packageId) {
        title.textContent = 'Edit Package';
        loadPackageData(packageId);
    } else {
        title.textContent = 'Create New Package';
        form.reset();
    }
}

function loadPackageData(packageId) {
    fetch(`/api/packages/${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const package = data.package;
                
                document.getElementById('packageName').value = package.name || '';
                document.getElementById('packageCategory').value = package.category || '';
                document.getElementById('packageDescription').value = package.description || '';
                document.getElementById('basePrice').value = package.base_price || '';
                document.getElementById('durationMinutes').value = package.duration_minutes || '';
                document.getElementById('isCustomizable').checked = package.is_customizable;
                document.getElementById('includes').value = (package.includes || []).join('\n');
                document.getElementById('requirements').value = (package.requirements || []).join('\n');
                document.getElementById('recommendedAge').value = package.recommended_age || '';
                document.getElementById('recommendedWeeks').value = package.recommended_weeks || '';
                document.getElementById('optimalTiming').value = package.optimal_timing || '';
                document.getElementById('displayOrder').value = package.display_order || 0;
                document.getElementById('isFeatured').checked = package.is_featured;
                document.getElementById('isActive').checked = package.is_active;
            }
        })
        .catch(error => {
            console.error('Error loading package data:', error);
            showAlert('Error loading package data', 'danger');
        });
}

function editPackage(packageId) {
    openPackageModal(packageId);
    const modal = new bootstrap.Modal(document.getElementById('packageModal'));
    modal.show();
}

function customizePackage(packageId) {
    // Open package customization modal (similar to client customization)
    fetch(`/api/packages/${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPackageCustomizationModal(data.package);
            } else {
                showAlert('Failed to load package details', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading package:', error);
            showAlert('Error loading package details', 'danger');
        });
}

function showPackageCustomizationModal(package) {
    // Create a simple customization modal for packages
    const modalHtml = `
        <div class="modal fade" id="packageCustomizationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Customize: ${package.name}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 class="card-title">${package.name}</h5>
                                                <p class="card-text text-muted">${package.description || 'Professional photography session'}</p>
                                                <span class="badge bg-primary">${package.category.charAt(0).toUpperCase() + package.category.slice(1)}</span>
                                            </div>
                                            <div class="text-end">
                                                <div class="h4 text-success mb-0">$${package.base_price}</div>
                                                <small class="text-muted">${package.duration_minutes} minutes</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Package Details</h6>
                                ${package.includes && package.includes.length > 0 ? `
                                    <h6 class="small text-muted mb-2">Includes:</h6>
                                    <ul class="small mb-3">
                                        ${package.includes.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                
                                ${package.recommended_age || package.recommended_weeks ? `
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">Session Information</h6>
                                        ${package.recommended_age ? `<p class="mb-1"><strong>Recommended Age:</strong> ${package.recommended_age}</p>` : ''}
                                        ${package.recommended_weeks ? `<p class="mb-0"><strong>Recommended Weeks:</strong> ${package.recommended_weeks}</p>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Customization Options</h6>
                                <div class="mb-3">
                                    <label class="form-label">Base Price</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="customPrice" value="${package.base_price}" step="0.01">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" class="form-control" id="customDuration" value="${package.duration_minutes}">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Special Notes</label>
                                    <textarea class="form-control" id="customNotes" rows="3" placeholder="Any special customization notes..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="savePackageCustomization('${package.id}')">
                            <i class="fas fa-save me-2"></i>Save Customization
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if it exists
    const existingModal = document.getElementById('packageCustomizationModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('packageCustomizationModal'));
    modal.show();
    
    // Store package data
    window.currentCustomizingPackage = package;
}

function savePackageCustomization(packageId) {
    const customPrice = document.getElementById('customPrice').value;
    const customDuration = document.getElementById('customDuration').value;
    const customNotes = document.getElementById('customNotes').value;
    
    // Update package with customizations
    const packageData = {
        ...window.currentCustomizingPackage,
        base_price: parseFloat(customPrice),
        duration_minutes: parseInt(customDuration),
        notes: customNotes
    };
    
    fetch(`/api/packages/${packageId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(packageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Package customized successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageCustomizationModal'));
            modal.hide();
            loadPackages(); // Refresh the packages list
        } else {
            showAlert('Failed to customize package: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error customizing package:', error);
        showAlert('Error customizing package', 'danger');
    });
}

function duplicatePackage(packageId) {
    fetch(`/api/packages/${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const package = data.package;
                package.name = package.name + ' (Copy)';
                delete package.id; // Remove ID so it creates a new package
                
                return fetch('/api/packages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(package)
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Package duplicated successfully!', 'success');
                loadPackages();
            } else {
                showAlert('Failed to duplicate package: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error duplicating package:', error);
            showAlert('Error duplicating package', 'danger');
        });
}

function deletePackage(packageId) {
    currentDeleteId = packageId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Handle package form submission
document.getElementById('packageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const packageData = {
        name: formData.get('name'),
        description: formData.get('description'),
        category: formData.get('category'),
        base_price: parseFloat(formData.get('base_price')),
        duration_minutes: parseInt(formData.get('duration_minutes')),
        is_customizable: formData.get('is_customizable') === 'on',
        includes: formData.get('includes').split('\n').filter(item => item.trim()),
        requirements: formData.get('requirements').split('\n').filter(item => item.trim()),
        recommended_age: formData.get('recommended_age'),
        recommended_weeks: formData.get('recommended_weeks'),
        optimal_timing: formData.get('optimal_timing'),
        display_order: parseInt(formData.get('display_order')),
        is_featured: formData.get('is_featured') === 'on',
        is_active: formData.get('is_active') === 'on'
    };
    
    const url = currentPackageId ? `/api/packages/${currentPackageId}` : '/api/packages';
    const method = currentPackageId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(packageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageModal'));
            modal.hide();
            loadPackages();
        } else {
            showAlert('Failed to save package: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving package:', error);
        showAlert('Error saving package', 'danger');
    });
});

// Handle delete confirmation
document.getElementById('confirmDelete').addEventListener('click', function() {
    if (currentDeleteId) {
        fetch(`/api/packages/${currentDeleteId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Package deleted successfully', 'success');
                loadPackages();
            } else {
                showAlert('Failed to delete package: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting package:', error);
            showAlert('Error deleting package', 'danger');
        })
        .finally(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            currentDeleteId = null;
        });
    }
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
