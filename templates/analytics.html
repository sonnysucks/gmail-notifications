{% extends "base.html" %}

{% block title %}Analytics - {{ business.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Business Analytics</h1>
            <p class="text-muted mb-0">Track your photography business performance and insights</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportData()">
                <i class="fas fa-download me-2"></i>
                Export Data
            </button>
            <button class="btn btn-outline-secondary" onclick="printReport()">
                <i class="fas fa-print me-2"></i>
                Print Report
            </button>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
                                <div class="col-xl-3 col-md-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1">${{ monthly_revenue.total if monthly_revenue and monthly_revenue.total else '4,800' }}</h4>
                                            <p class="mb-0">Monthly Revenue</p>
                                        </div>
                                        <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1">{{ session_stats.total_sessions if session_stats and session_stats.total_sessions else '30' }}</h4>
                                            <p class="mb-0">Total Sessions</p>
                                        </div>
                                        <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-camera fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1">{{ client_acquisition.new_clients if client_acquisition and client_acquisition.new_clients else '25' }}</h4>
                                            <p class="mb-0">New Clients</p>
                                        </div>
                                        <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-user-plus fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h4 class="mb-1">${{ session_stats.avg_session_value if session_stats and session_stats.avg_session_value else '250' }}</h4>
                                            <p class="mb-0">Avg Session Value</p>
                                        </div>
                                        <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-chart-line fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    </div>

    <div class="row g-4">
        <!-- Revenue Chart -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Monthly Revenue Trend
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Session Type Distribution -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Session Types
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionTypeChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-4">
        <!-- Client Acquisition -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Client Acquisition
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="clientAcquisitionChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Milestone Package Performance -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-baby me-2"></i>
                        Milestone Package Performance
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="milestoneChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Statistics Tables -->
    <div class="row g-4 mt-4">
        <!-- Top Performing Session Types -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Top Performing Session Types
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Session Type</th>
                                    <th>Count</th>
                                    <th>Revenue</th>
                                    <th>Avg Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if session_stats and session_stats.by_type %}
                                    {% for session_type, stats in session_stats.by_type.items() %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ session_type.title() }}</span>
                                        </td>
                                        <td>{{ stats.count or 0 }}</td>
                                        <td>${{ stats.revenue or 0 }}</td>
                                        <td>${{ stats.avg_value or 0 }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <!-- Sample data for demonstration -->
                                    <tr>
                                        <td><span class="badge bg-primary">Newborn</span></td>
                                        <td>12</td>
                                        <td>$3,000</td>
                                        <td>$250</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-success">Milestone</span></td>
                                        <td>8</td>
                                        <td>$1,600</td>
                                        <td>$200</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-warning">Birthday</span></td>
                                        <td>6</td>
                                        <td>$1,350</td>
                                        <td>$225</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-info">Family</span></td>
                                        <td>4</td>
                                        <td>$1,200</td>
                                        <td>$300</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referral Source Analysis -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-share-alt me-2"></i>
                        Referral Source Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Clients</th>
                                    <th>Conversion Rate</th>
                                    <th>Avg Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if client_acquisition and client_acquisition.by_source %}
                                    {% for source, data in client_acquisition.by_source.items() %}
                                    <tr>
                                        <td>{{ source.replace('_', ' ').title() }}</td>
                                        <td>{{ data.count or 0 }}</td>
                                        <td>{{ data.conversion_rate or '0%' }}</td>
                                        <td>${{ data.avg_value or 0 }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <!-- Sample data for demonstration -->
                                    <tr>
                                        <td>Social Media</td>
                                        <td>15</td>
                                        <td>85%</td>
                                        <td>$275</td>
                                    </tr>
                                    <tr>
                                        <td>Google Search</td>
                                        <td>8</td>
                                        <td>70%</td>
                                        <td>$300</td>
                                    </tr>
                                    <tr>
                                        <td>Friend/Family</td>
                                        <td>12</td>
                                        <td>95%</td>
                                        <td>$250</td>
                                    </tr>
                                    <tr>
                                        <td>Previous Client</td>
                                        <td>5</td>
                                        <td>100%</td>
                                        <td>$350</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Insights -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Business Insights & Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="insight-card bg-light p-3 rounded">
                                <h6 class="text-primary">
                                    <i class="fas fa-arrow-up me-2"></i>
                                    Revenue Growth
                                </h6>
                                <p class="mb-0">Your monthly revenue has increased by 15% compared to last month. Consider expanding your most popular session types.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="insight-card bg-light p-3 rounded">
                                <h6 class="text-success">
                                    <i class="fas fa-star me-2"></i>
                                    Client Retention
                                </h6>
                                <p class="mb-0">75% of your clients are returning customers. Focus on building long-term relationships and offering package deals.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="insight-card bg-light p-3 rounded">
                                <h6 class="text-info">
                                    <i class="fas fa-bullseye me-2"></i>
                                    Peak Seasons
                                </h6>
                                <p class="mb-0">Spring and fall are your busiest seasons. Plan marketing campaigns and special offers during slower months.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="insight-card bg-light p-3 rounded">
                                <h6 class="text-warning">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Pricing Strategy
                                </h6>
                                <p class="mb-0">Your milestone sessions have the highest profit margin. Consider promoting these more aggressively.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sample data for charts (replace with actual data from backend)
    const revenueData = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
        datasets: [{
            label: 'Monthly Revenue',
            data: [2500, 3200, 2800, 4100, 3800, 4500, 4200, 4800],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };

    const sessionTypeData = {
        labels: ['Newborn', 'Milestone', 'Birthday', 'Family', 'Maternity'],
        datasets: [{
            data: [30, 25, 20, 15, 10],
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6f42c1'
            ]
        }]
    };

    const clientAcquisitionData = {
        labels: ['Social Media', 'Google', 'Referrals', 'Previous Clients'],
        datasets: [{
            label: 'New Clients',
            data: [45, 30, 15, 10],
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545'
            ]
        }]
    };

    const milestoneData = {
        labels: ['3 Month', '6 Month', '9 Month', '12 Month'],
        datasets: [{
            label: 'Revenue',
            data: [1200, 1800, 1600, 2000],
            backgroundColor: '#28a745'
        }]
    };

    // Create charts
    new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: revenueData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('sessionTypeChart'), {
        type: 'doughnut',
        data: sessionTypeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    new Chart(document.getElementById('clientAcquisitionChart'), {
        type: 'bar',
        data: clientAcquisitionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    new Chart(document.getElementById('milestoneChart'), {
        type: 'bar',
        data: milestoneData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
});

function exportData() {
    // Implementation for exporting analytics data
    alert('Export functionality will be implemented here. This would download a CSV or Excel file with all analytics data.');
}

function printReport() {
    window.print();
}
</script>

<style>
.insight-card {
    border-left: 4px solid #007bff;
    transition: transform 0.2s;
}

.insight-card:hover {
    transform: translateY(-2px);
}

@media print {
    .btn, .card-header {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}
